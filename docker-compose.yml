version: '3.8'

services:
  # Database Service (SQL Server)
  db:
    image: mcr.microsoft.com/mssql/server:2022-latest
    container_name: expensetracker-db
    user: root # Run as root to fix Access Denied error
    environment:
      - ACCEPT_EULA=Y
      - MSSQL_SA_PASSWORD=YourStrong@Passw0rd # Change this in production!
    ports:
      - "1433:1433"
    volumes:
      - sqlvolume:/var/opt/mssql/data
    healthcheck:
      test: [ "CMD-SHELL", "/opt/mssql-tools18/bin/sqlcmd -S localhost -U sa -P YourStrong@Passw0rd -C -Q 'SELECT 1' || exit 1" ]
      interval: 10s
      retries: 5
      start_period: 10s
      timeout: 3s

  # Cache Service (Redis)
  redis:
    image: redis:latest
    container_name: expensetracker-redis
    ports:
      - "6379:6379"

  # Backend Service (.NET 8 Web API)
  backend:
    build:
      context: ./Backend/ExpenseAPI
      dockerfile: Dockerfile
    container_name: expensetracker-backend
    environment:
      - ConnectionStrings__DefaultConnection=Server=db;Database=ExpenseTrackerDB;User Id=sa;Password=YourStrong@Passw0rd;TrustServerCertificate=True
      - ConnectionStrings__Redis=redis:6379
      - ASPNETCORE_URLS=http://+:8080
      - ASPNETCORE_ENVIRONMENT=Development
    ports:
      - "8080:8080"
      - "8081:8081"
    volumes:
      # - ./Backend/ExpenseAPI:/app # Commented out to fix mount issue
      - /app/obj # Prevent host obj folder from conflicting
      - /app/bin # Prevent host bin folder from conflicting
    depends_on:
      db:
        condition: service_healthy
      redis:
        condition: service_started

  # Frontend Service (React)
  frontend:
    build:
      context: ./expense-tracker-ui
      dockerfile: Dockerfile
    container_name: expensetracker-frontend
    environment:
      - CHOKIDAR_USEPOLLING=true # Enable polling for hot reload
      - WATCHPACK_POLLING=true
      - REACT_APP_API_BASE_URL=http://localhost:8080/api # Adjust based on how frontend accesses backend
    ports:
      - "3000:3000"
    volumes:
      # - ./expense-tracker-ui:/app # Commented out to fix mount issue
      - /app/node_modules # Use container's node_modules
    depends_on:
      - backend
    stdin_open: true # Needed for interactive mode (like Create-React-App)
    tty: true

volumes:
  sqlvolume:
